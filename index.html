<!DOCTYPE html>
<!--suppress HtmlDeprecatedAttribute -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prize Claim Portal</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <link rel="icon" href="https://crispystacks.com/gallery/favicons/favicon.png" type="image/png">
    <link rel="icon" href="https://crispystacks.com/gallery/favicons/favicon-60x60.png" sizes="60x60" type="image/png">
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-200 text-slate-800 min-h-screen flex flex-col items-center justify-center p-4">

<div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transition-all duration-300">

    <div class="h-2 bg-gradient-to-r from-red-600 to-red-500"></div>

    <div class="p-8">

        <div class="flex justify-center mb-6">
            <img
                    src="https://crispystacks.com/gallery_gen/70a3149714b18a46e3af0c11da41f88a_600x470_fit.png?ts=1762528991"
                    alt="Logo"
                    class="h-24 w-auto object-contain"
            >
        </div>

        <div id="login-state" class="animate-slide-up text-center">
            <div class="mb-8">
                <h1 class="text-2xl font-bold tracking-tight text-slate-900">Claim Your Prize</h1>
                <p class="text-slate-500 mt-2 text-sm">Sign in to verify your winning entry.</p>
            </div>

            <div class="space-y-4">
                <button id="login-button" class="group relative w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200 shadow-md hover:shadow-lg">
                    <svg class="w-5 h-5 mr-3 text-white/90 group-hover:text-white transition-colors" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.377.505 9.377.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                    </svg>
                    Sign In with YouTube
                </button>

                <div id="error-message" class="hidden p-3 rounded-lg bg-red-50 border border-red-100 text-red-600 text-sm text-center animate-fade-in">
                    Authorization failed. Please try again.
                </div>
                <button id="skip-to-form-button" class="hidden group relative w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-all duration-200 shadow-md hover:shadow-lg">
                    Skip to Form (Dev)
                </button>
            </div>

            <div class="mt-8 text-center text-xs text-slate-400">
                Powered by YouTube Data API
            </div>
        </div>

        <div id="loading-state" class="hidden py-8 text-center animate-fade-in">
            <div class="relative w-16 h-16 mx-auto">
                <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-red-600 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <h3 class="mt-6 text-lg font-medium text-slate-900">Verifying Account</h3>
            <p class="text-slate-500 text-sm mt-1">Checking your channel credentials...</p>
        </div>


        <div id="form-state" class="hidden animate-fade-in">
            <div class="flex items-center justify-between mb-8 p-4 bg-slate-50 rounded-lg border border-slate-100">
                <div>
                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Identity Verified</p>
                    <p id="user-name" class="font-bold text-slate-800 text-lg mt-0.5">John Doe</p>
                   <br>
                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Email Address</p>

                    <p id="user-email" class="font-bold text-slate-800 text-lg mt-0.5">john.doe@example.com</p>
                    <br>

                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wide">YouTube Username</p>
                    <p id="youtube-username" class="font-bold text-slate-800 text-lg mt-0.5">YouTubeUserName</p>
                </div>
                <div class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-medium flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Verified
                </div>
            </div>

            <form id="details-form" class="space-y-5">
                <!-- Qualifier Text -->


                <!-- What did you win? -->
                <div>
                    <label for="what-you-won" class="block text-sm font-medium text-slate-700 mb-1">What did you win?</label>
                    <input type="text" id="what-you-won" required class="w-full rounded-lg border-slate-300 border px-4 py-2.5 text-slate-900 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-shadow bg-slate-50 focus:bg-white shadow-sm">
                </div>

                <!-- Shipping Options -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">How would you like to receive your prize?</label>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input id="shipping-option-shipping" name="shipping-option" type="radio" value="shipping" checked class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                            <label for="shipping-option-shipping" class="ml-2 block text-sm text-slate-900">Ship my prize</label>
                        </div>
                        <div class="flex items-center">
                            <input id="shipping-option-pickup" name="shipping-option" type="radio" value="pickup" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                            <label for="shipping-option-pickup" class="ml-2 block text-sm text-slate-900">Local pickup (Utah County)</label>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address Fields -->
                <div id="shipping-address-fields" class="space-y-5">
                    <h2 class="text-xl font-bold text-slate-900 mb-0">Where should we send it?</h2>
                    <div>
                        <label for="full-name" class="block text-sm font-medium text-slate-700 mb-1">Full Name (for shipping label)</label>
                        <input type="text" id="full-name" autocomplete="name" required class="w-full rounded-lg border-slate-300 border px-4 py-2.5 text-slate-900 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-shadow bg-slate-50 focus:bg-white shadow-sm">
                    </div>

                    <div>
                        <label for="address-line1" class="block text-sm font-medium text-slate-700 mb-1">Address Line 1</label>
                        <input type="text" id="address-line1" autocomplete="address-line1" required class="w-full rounded-lg border-slate-300 border px-4 py-2.5 text-slate-900 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-shadow bg-slate-50 focus:bg-white shadow-sm">
                    </div>

                    <div>
                        <label for="city" class="block text-sm font-medium text-slate-700 mb-1">City</label>
                        <input type="text" id="city" autocomplete="address-level2" required class="w-full rounded-lg border-slate-300 border px-4 py-2.5 text-slate-900 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-shadow bg-slate-50 focus:bg-white shadow-sm">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="state" class="block text-sm font-medium text-slate-700 mb-1">State</label>
                            <input type="text" id="state" autocomplete="address-level1" required class="w-full rounded-lg border-slate-300 border px-4 py-2.5 text-slate-900 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-shadow bg-slate-50 focus:bg-white shadow-sm">
                        </div>
                        <div>
                            <label for="zip" class="block text-sm font-medium text-slate-700 mb-1">ZIP Code</label>
                            <input type="text" id="zip" autocomplete="postal-code" required class="w-full rounded-lg border-slate-300 border px-4 py-2.5 text-slate-900 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-shadow bg-slate-50 focus:bg-white shadow-sm">
                        </div>
                    </div>
                </div>
                <!-- Shipping Issues Checkbox -->
                <div id="shipping-issues-container" class="flex items-center">
                    <input id="shipping-issues" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded" required>
                    <label for="shipping-issues" class="ml-2 block text-sm text-slate-900">
                        * I understand that Crispy Stacks is not responsible for lost or damaged mail.
                    </label>
                </div>
                <!-- Questions or Comments? -->
                <div>
                    <label for="comments" class="block text-sm font-medium text-slate-700 mb-1">Questions or Comments? (Optional)</label>
                    <textarea id="comments" rows="3" class="w-full rounded-lg border-slate-300 border px-4 py-2.5 text-slate-900 focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none transition-shadow bg-slate-50 focus:bg-white shadow-sm"></textarea>
                </div>

                <button type="submit" class="w-full mt-2 bg-slate-900 hover:bg-slate-800 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-colors duration-200 focus:ring-2 focus:ring-offset-2 focus:ring-slate-900">
                    Submit Details
                </button>


            </form>
        </div>

        <div id="success-state" class="hidden text-center py-8 animate-fade-in">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-900 mb-2">You're all set!</h2>
            <p class="text-slate-600 max-w-xs mx-auto">Your shipping information has been received. Watch your inbox for tracking details.</p>
            <button onclick="location.reload()" class="mt-8 text-sm text-red-600 font-medium hover:text-red-700">
                Back to Home
            </button>
        </div>

    </div>
</div>

</script>
<script>
    let userAccessToken = null;

    // --- ‚öôÔ∏è CONFIGURATION ‚öôÔ∏è ---
    const CLIENT_ID = '753346673939-e63gqpcmgvruea5a3da783q66hmcv59e.apps.googleusercontent.com'; // <-- Paste your ID here
    const YOUTUBE_SCOPE = 'https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
    const SERVICE_URL = 'https://giveaway-backend-753346673939.us-central1.run.app';
    // -----------------------------

    // Elements
    const views = {
        login: document.getElementById('login-state'),
        loading: document.getElementById('loading-state'),
        form: document.getElementById('form-state'),
        success: document.getElementById('success-state')
    };
    const errorMsg = document.getElementById('error-message');

    // Switch View Helper
    function switchView(viewName) {
        Object.values(views).forEach(el => el.classList.add('hidden'));
        views[viewName].classList.remove('hidden');
    }

    // Google Identity Services Initialization
    let tokenClient;
    function initClient() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: YOUTUBE_SCOPE,
            callback: (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) {
                    verifyUser(tokenResponse.access_token);
                } else {
                    errorMsg.classList.remove('hidden');
                }
            },
            error_callback: (err) => {
                console.error(err);
                errorMsg.classList.remove('hidden');
            }
        });
    }

    // Wait for Google Script
    window.onload = () => {
        // --- Local Dev Skip ---
        const skipButton = document.getElementById('skip-to-form-button');
        if (['localhost', '127.0.0.1'].includes(window.location.hostname)) {
            if (skipButton) {
                skipButton.classList.remove('hidden');
                skipButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView('form');
                });
            }
        }
        // -----------------------

        // --- Shipping Options ---
        const shippingAddressFields = document.getElementById('shipping-address-fields');
        const shippingOptionShipping = document.getElementById('shipping-option-shipping');
        const shippingOptionPickup = document.getElementById('shipping-option-pickup');
        const shippingIssuesContainer = document.getElementById('shipping-issues-container');

        function toggleShippingFields() {
            if (shippingOptionShipping.checked) {
                shippingAddressFields.classList.remove('hidden');
                shippingIssuesContainer.classList.remove('hidden');
            } else {
                shippingAddressFields.classList.add('hidden');
                shippingIssuesContainer.classList.add('hidden');
            }
        }

        shippingOptionShipping.addEventListener('change', toggleShippingFields);
        shippingOptionPickup.addEventListener('change', toggleShippingFields);

        // Initial check
        toggleShippingFields();
        // -----------------------

        const checkGoogle = setInterval(() => {
            if (window.google && window.google.accounts) {
                clearInterval(checkGoogle);
                initClient();
            }
        }, 100);
    };

    // Event Listeners
    document.getElementById('login-button').addEventListener('click', () => {
        errorMsg.classList.add('hidden');
        if (tokenClient) tokenClient.requestAccessToken();
    });

    document.getElementById('details-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        // Simulate API submission
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerText;

        submitBtn.disabled = true;
        submitBtn.innerText = "Sending...";
        submitBtn.classList.add('opacity-75');

        // Collect Data
        const data = {
            whatYouWon: document.getElementById('what-you-won').value,
            shippingOption: document.querySelector('input[name="shipping-option"]:checked').value,
            fullName: document.getElementById('full-name').value,
            addressLine1: document.getElementById('address-line1').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            zip: document.getElementById('zip').value,
            comments: document.getElementById('comments').value,
            youtubeUsername: document.getElementById('youtube-username').textContent,
            email: document.getElementById('user-email').textContent,
        };

        console.log("üì¶ Payload:", data);

        try {
            const response = await fetch(`${SERVICE_URL}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userAccessToken}`
                },
                body: JSON.stringify(data),
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(errorBody.message || 'Submission failed');
            }

            switchView('success');
        } catch (error) {
            console.error("Submission error:", error);
            errorMsg.textContent = `Submission failed: ${error.message}`;
            errorMsg.classList.remove('hidden');
            switchView('form'); // Stay on the form to allow correction
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = originalText;
            submitBtn.classList.remove('opacity-75');
        }
    });

    // API Logic
    async function verifyUser(token) {
        switchView('loading');
        try {
            // Parallel API calls
            const [youtubeRes, userInfoRes] = await Promise.all([
                fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
                    headers: { 'Authorization': `Bearer ${token}` }
                }),
                fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
            ]);

            if (!youtubeRes.ok || !userInfoRes.ok) throw new Error('One or more API calls failed');

            const youtubeData = await youtubeRes.json();
            const userInfoData = await userInfoRes.json();

            if (youtubeData.items?.length > 0) {
                userAccessToken = token;
                document.getElementById('youtube-username').textContent = youtubeData.items[0].snippet.title;
                document.getElementById('user-name').textContent = userInfoData.name || 'N/A';
                document.getElementById('user-email').textContent = userInfoData.email || 'N/A';
                document.getElementById('full-name').value = userInfoData.name || ''; // Pre-fill name
                switchView('form');
            } else {
                throw new Error('No Channel Found');
            }
        } catch (err) {
            console.error(err);
            switchView('login');
            errorMsg.textContent = "Verification failed. Could not retrieve all user details. Try again.";
            errorMsg.classList.remove('hidden');
        }
    }
</script>
</body>
</html>